<ui:FluentWindow x:Class="FleetAutomate.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:ui="http://schemas.lepo.co/wpfui/2022/xaml"
        xmlns:avalonDock="https://github.com/Dirkster99/AvalonDock"
        xmlns:local="clr-namespace:Canvas.TestRunner"
        xmlns:vm="clr-namespace:FleetAutomate.ViewModel"
        xmlns:converters="clr-namespace:FleetAutomate.Converters"
        xmlns:model="clr-namespace:FleetAutomate.Model"
        xmlns:actions="clr-namespace:FleetAutomate.Model.Actions.Logic"
        xmlns:view="clr-namespace:FleetAutomate.View"
        WindowStyle="None"
        mc:Ignorable="d"
        Height="700" Width="1200">
    <ui:FluentWindow.DataContext>
        <vm:MainViewModel/>
    </ui:FluentWindow.DataContext>
    <ui:FluentWindow.Resources>
        <converters:ProjectToTitleConverter x:Key="ProjectToTitleConverter"/>
        <converters:ProjectToStatusConverter x:Key="ProjectToStatusConverter"/>
        <converters:ActionStateToIconConverter x:Key="ActionStateToIconConverter"/>
        <converters:ActionStateToColorConverter x:Key="ActionStateToColorConverter"/>
        <converters:ActionStateToSymbolConverter x:Key="ActionStateToSymbolConverter"/>
        <converters:ActionTypeToIconConverter x:Key="ActionTypeToIconConverter"/>
        <converters:ActionToFormattedNameConverter x:Key="ActionToFormattedNameConverter"/>

        <!-- Easing function for smooth pulsing animation -->
        <SineEase x:Key="SineEase" EasingMode="EaseInOut"/>
    </ui:FluentWindow.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- TitleBar -->
        <ui:TitleBar Background="LightGray" Height="30"
                     Title="{Binding ActiveProject, Converter={StaticResource ProjectToTitleConverter}}"
                     Grid.Row="0"/>

        <!-- Menu -->
        <Menu Grid.Row="1">
            <ui:MenuItem Header="File" Icon="{ui:SymbolIcon DocumentSplitHint20}">
                <MenuItem Header="New Project" Command="{Binding CreateNewProjectCommand}"
                         InputGestureText="Ctrl+N"/>
                <MenuItem Header="Open Project..." Command="{Binding OpenProjectCommand}"
                         InputGestureText="Ctrl+O"/>
                <MenuItem Header="Open Recent" Name="OpenRecentMenu">
                    <MenuItem Header="No Recent Projects" IsEnabled="False"/>
                </MenuItem>
                <Separator />
                <MenuItem Header="Save" Command="{Binding SaveProjectCommand}"
                         InputGestureText="Ctrl+S"/>
                <MenuItem Header="Save As..." Command="{Binding SaveProjectAsCommand}"
                         IsEnabled="{Binding IsProjectLoaded}"
                         InputGestureText="Ctrl+Shift+S"/>
                <Separator />
                <MenuItem Header="Close Project" Command="{Binding CloseProjectCommand}"
                         IsEnabled="{Binding IsProjectLoaded}"/>
                <Separator />
                <MenuItem Header="Exit" Click="ExitMenuItem_Click"
                         InputGestureText="Alt+F4"/>
            </ui:MenuItem>
            <Separator/>
            <ui:MenuItem Header="Open Project" Icon="{ui:SymbolIcon FolderOpen20}"
                        Command="{Binding OpenProjectCommand}"
                        ToolTip="Open Project (Ctrl+O)"/>
            <ui:MenuItem Header="Save" Icon="{ui:SymbolIcon Save20}"
                        Command="{Binding SaveProjectCommand}"
                        ToolTip="Save Project (Ctrl+S)"/>
            <!-- Execute button - visible when not running -->
            <ui:MenuItem Header="Execute" Icon="{ui:SymbolIcon Play20}"
                        Command="{Binding RunTestFlowCommand}"
                        ToolTip="Execute TestFlow (F5)">
                <ui:MenuItem.Style>
                    <Style TargetType="ui:MenuItem">
                        <Style.Triggers>
                            <DataTrigger Binding="{Binding IsTestFlowRunning}" Value="True">
                                <Setter Property="Visibility" Value="Collapsed"/>
                            </DataTrigger>
                        </Style.Triggers>
                    </Style>
                </ui:MenuItem.Style>
            </ui:MenuItem>
            <!-- Pause button - visible when running and not paused -->
            <ui:MenuItem Header="Pause" Icon="{ui:SymbolIcon Pause20}"
                        Command="{Binding PauseTestFlowCommand}"
                        ToolTip="Pause TestFlow">
                <ui:MenuItem.Style>
                    <Style TargetType="ui:MenuItem">
                        <Setter Property="Visibility" Value="Collapsed"/>
                        <Style.Triggers>
                            <MultiDataTrigger>
                                <MultiDataTrigger.Conditions>
                                    <Condition Binding="{Binding IsTestFlowRunning}" Value="True"/>
                                    <Condition Binding="{Binding IsTestFlowNotPaused}" Value="True"/>
                                </MultiDataTrigger.Conditions>
                                <Setter Property="Visibility" Value="Visible"/>
                            </MultiDataTrigger>
                        </Style.Triggers>
                    </Style>
                </ui:MenuItem.Style>
            </ui:MenuItem>
            <!-- Continue button - visible when paused -->
            <ui:MenuItem Header="Continue" Icon="{ui:SymbolIcon Play20}"
                        Command="{Binding ContinueTestFlowCommand}"
                        ToolTip="Continue TestFlow">
                <ui:MenuItem.Style>
                    <Style TargetType="ui:MenuItem">
                        <Setter Property="Visibility" Value="Collapsed"/>
                        <Style.Triggers>
                            <DataTrigger Binding="{Binding IsTestFlowPaused}" Value="True">
                                <Setter Property="Visibility" Value="Visible"/>
                            </DataTrigger>
                        </Style.Triggers>
                    </Style>
                </ui:MenuItem.Style>
            </ui:MenuItem>
            <!-- Stop button - visible when running -->
            <ui:MenuItem Header="Stop" Icon="{ui:SymbolIcon Stop20}"
                        Command="{Binding StopTestFlowCommand}"
                        ToolTip="Stop TestFlow">
                <ui:MenuItem.Style>
                    <Style TargetType="ui:MenuItem">
                        <Setter Property="Visibility" Value="Collapsed"/>
                        <Style.Triggers>
                            <DataTrigger Binding="{Binding IsTestFlowRunning}" Value="True">
                                <Setter Property="Visibility" Value="Visible"/>
                            </DataTrigger>
                        </Style.Triggers>
                    </Style>
                </ui:MenuItem.Style>
            </ui:MenuItem>
            <ui:MenuItem Header="Edit" Icon="{ui:SymbolIcon DocumentEdit20}">
                <MenuItem Header="Undo" InputGestureText="Ctrl+Z" IsEnabled="False"/>
                <MenuItem Header="Redo" InputGestureText="Ctrl+Y" IsEnabled="False"/>
                <Separator />
                <MenuItem Header="Cut" InputGestureText="Ctrl+X" IsEnabled="False"/>
                <MenuItem Header="Copy" InputGestureText="Ctrl+C" IsEnabled="False"/>
                <MenuItem Header="Paste" InputGestureText="Ctrl+V" IsEnabled="False"/>
                <Separator />
                <MenuItem Header="Find..." InputGestureText="Ctrl+F" IsEnabled="False"/>
                <MenuItem Header="Find next" InputGestureText="F3" IsEnabled="False"/>
                <MenuItem Header="Replace..." InputGestureText="Ctrl+H" IsEnabled="False"/>
                <Separator />
                <MenuItem Header="Select All" InputGestureText="Ctrl+A" IsEnabled="False"/>
            </ui:MenuItem>
            <ui:MenuItem Header="Project" Icon="{ui:SymbolIcon Folder20}" IsEnabled="{Binding IsProjectLoaded}">
                <MenuItem Header="Add TestFlow..." Click="AddTestFlowMenuItem_Click"/>
                <MenuItem Header="Add Existing TestFlow..." Command="{Binding AddExistingTestFlowCommand}"/>
                <MenuItem Header="Project Properties..." IsEnabled="False"/>
                <Separator />
                <MenuItem Header="Run" Command="{Binding RunTestFlowCommand}"
                         InputGestureText="F5"/>
            </ui:MenuItem>
            <ui:MenuItem Header="View" Icon="{ui:SymbolIcon Eye20}">
                <MenuItem Header="Output" IsEnabled="False"/>
                <MenuItem Header="Error List" IsEnabled="False"/>
                <MenuItem Header="Properties" IsEnabled="False"/>
            </ui:MenuItem>
            <ui:MenuItem Header="Tools" Icon="{ui:SymbolIcon Wrench20}">
                <MenuItem Header="Capture Element" Click="CaptureElementMenuItem_Click"
                         ToolTip="Press Ctrl while hovering to capture UI element (F12)"/>
            </ui:MenuItem>
        </Menu>

        <!-- AvalonDock DockingManager -->
        <avalonDock:DockingManager Grid.Row="2"
                                   AllowMixedOrientation="True"
                                   BorderBrush="Gray"
                                   BorderThickness="0">

            <avalonDock:LayoutRoot>
                <avalonDock:LayoutPanel Orientation="Horizontal">

                    <!-- Left Side: ToolBox and TestFlows -->
                    <avalonDock:LayoutAnchorablePaneGroup DockWidth="250" Orientation="Vertical">

                        <!-- ToolBox Pane -->
                        <avalonDock:LayoutAnchorablePane DockHeight="*">
                            <avalonDock:LayoutAnchorable Title="ToolBox" CanClose="False" CanHide="False">
                                <TreeView Name="ActionsToolBox"
                                          ItemsSource="{Binding ActionCategories}"
                                          MouseDoubleClick="ActionsToolBox_MouseDoubleClick">

                                    <!-- Category Level (HierarchicalDataTemplate) -->
                                    <TreeView.ItemTemplate>
                                        <HierarchicalDataTemplate ItemsSource="{Binding Actions}">
                                            <StackPanel Orientation="Horizontal" Margin="2">
                                                <TextBlock Text="{Binding Icon}"
                                                           FontSize="16"
                                                           Margin="0,0,5,0"
                                                           VerticalAlignment="Center"/>
                                                <TextBlock Text="{Binding Name}"
                                                           FontWeight="Bold"
                                                           FontSize="12"/>
                                            </StackPanel>

                                            <!-- Action Level (nested DataTemplate) -->
                                            <HierarchicalDataTemplate.ItemTemplate>
                                                <DataTemplate>
                                                    <StackPanel Orientation="Horizontal" Margin="5,2">
                                                        <TextBlock Text="{Binding Icon}"
                                                                   FontSize="14"
                                                                   Margin="0,0,5,0"
                                                                   VerticalAlignment="Center"/>
                                                        <StackPanel>
                                                            <TextBlock Text="{Binding Name}"
                                                                       FontWeight="Bold"
                                                                       FontSize="11"/>
                                                            <TextBlock Text="{Binding Description}"
                                                                       FontSize="9"
                                                                       Foreground="Gray"/>
                                                        </StackPanel>
                                                    </StackPanel>
                                                </DataTemplate>
                                            </HierarchicalDataTemplate.ItemTemplate>
                                        </HierarchicalDataTemplate>
                                    </TreeView.ItemTemplate>

                                    <!-- All categories expanded by default -->
                                    <TreeView.ItemContainerStyle>
                                        <Style TargetType="TreeViewItem">
                                            <Setter Property="IsExpanded" Value="True"/>
                                        </Style>
                                    </TreeView.ItemContainerStyle>
                                </TreeView>
                            </avalonDock:LayoutAnchorable>
                        </avalonDock:LayoutAnchorablePane>

                        <!-- TestFlows Pane -->
                        <avalonDock:LayoutAnchorablePane DockHeight="300">
                            <avalonDock:LayoutAnchorable Title="TestFlows" CanClose="False" CanHide="False">
                                <ListView Name="TestFlowsListView" ItemsSource="{Binding ActiveProject.TestFlows}"
                                         SelectionMode="Single"
                                         MouseDoubleClick="TestFlowsListView_MouseDoubleClick"
                                         PreviewMouseDown="TestFlowsListView_PreviewMouseDown">
                                    <ListView.ContextMenu>
                                        <ContextMenu>
                                            <MenuItem Header="Run TestFlow" IsEnabled="False"/>
                                            <Separator/>
                                            <MenuItem Header="Enable/Disable" IsEnabled="False"/>
                                            <Separator/>
                                            <MenuItem Header="Remove TestFlow" IsEnabled="False"/>
                                        </ContextMenu>
                                    </ListView.ContextMenu>
                                    <ListView.ItemTemplate>
                                        <DataTemplate>
                                            <Grid Margin="5">
                                                <Grid.RowDefinitions>
                                                    <RowDefinition Height="Auto"/>
                                                    <RowDefinition Height="Auto"/>
                                                    <RowDefinition Height="Auto"/>
                                                </Grid.RowDefinitions>

                                                <!-- TestFlow Name -->
                                                <TextBlock Grid.Row="0" Text="{Binding Name}" FontWeight="Bold" FontSize="12"/>

                                                <!-- Description -->
                                                <TextBlock Grid.Row="1" Text="{Binding Description}" FontSize="10"
                                                          Foreground="Gray" TextWrapping="Wrap" MaxWidth="220"/>

                                                <!-- Status and Actions Count -->
                                                <StackPanel Grid.Row="2" Orientation="Horizontal" Margin="0,2,0,0">
                                                    <TextBlock Text="â—" FontSize="8" VerticalAlignment="Center" Margin="0,0,3,0">
                                                        <TextBlock.Style>
                                                            <Style TargetType="TextBlock">
                                                                <Setter Property="Foreground" Value="Green"/>
                                                                <Style.Triggers>
                                                                    <DataTrigger Binding="{Binding IsEnabled}" Value="False">
                                                                        <Setter Property="Foreground" Value="Red"/>
                                                                    </DataTrigger>
                                                                </Style.Triggers>
                                                            </Style>
                                                        </TextBlock.Style>
                                                    </TextBlock>
                                                    <TextBlock Text="{Binding Actions.Count, StringFormat=\{0\} actions}" FontSize="10" Foreground="Gray"/>
                                                </StackPanel>
                                            </Grid>
                                        </DataTemplate>
                                    </ListView.ItemTemplate>
                                    <ListView.ItemContainerStyle>
                                        <Style TargetType="ListViewItem">
                                            <Setter Property="HorizontalContentAlignment" Value="Stretch"/>
                                            <Style.Triggers>
                                                <DataTrigger Binding="{Binding IsEnabled}" Value="False">
                                                    <Setter Property="Opacity" Value="0.6"/>
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </ListView.ItemContainerStyle>
                                </ListView>
                            </avalonDock:LayoutAnchorable>
                        </avalonDock:LayoutAnchorablePane>

                    </avalonDock:LayoutAnchorablePaneGroup>

                    <!-- Center: TestFlow Actions Documents (dynamically populated) -->
                    <avalonDock:LayoutPanel Orientation="Vertical">
                        <avalonDock:LayoutDocumentPane x:Name="DocumentPane">
                            <!-- Documents will be added dynamically from code-behind -->
                            <!-- Empty placeholder -->
                            <avalonDock:LayoutDocument Title="Welcome" CanClose="False" x:Name="PlaceholderDocument">
                                <TextBlock Text="Double-click a TestFlow in the left panel to open it"
                                          HorizontalAlignment="Center"
                                          VerticalAlignment="Center"
                                          FontStyle="Italic"
                                          Foreground="Gray"
                                          FontSize="14"/>
                            </avalonDock:LayoutDocument>
                        </avalonDock:LayoutDocumentPane>

                        <!-- Bottom: Output View -->
                        <avalonDock:LayoutAnchorablePane DockHeight="200">
                            <avalonDock:LayoutAnchorable Title="ðŸ“ Output" CanClose="False">
                                <view:OutputView/>
                            </avalonDock:LayoutAnchorable>
                        </avalonDock:LayoutAnchorablePane>
                    </avalonDock:LayoutPanel>

                </avalonDock:LayoutPanel>
            </avalonDock:LayoutRoot>
        </avalonDock:DockingManager>

        <!-- Status Bar -->
        <StatusBar Grid.Row="3">
            <StatusBarItem>
                <TextBlock Text="{Binding CurrentProjectPath, Converter={StaticResource ProjectToStatusConverter}}" />
            </StatusBarItem>
            <Separator />
            <StatusBarItem>
                <TextBlock Text="{Binding HasUnsavedChanges, StringFormat='Modified: {0}', FallbackValue='Saved'}" />
            </StatusBarItem>
            <Separator />
            <StatusBarItem>
                <TextBlock Text="{Binding ActiveProject.TestFlows.Count, StringFormat='TestFlows: {0}', FallbackValue='0'}" />
            </StatusBarItem>
        </StatusBar>

    </Grid>
</ui:FluentWindow>
